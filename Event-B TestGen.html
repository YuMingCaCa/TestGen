<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Event-B TestGen: Smart Contract Verification</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body { font-family: 'Inter', 'Segoe UI', sans-serif; background-color: #f8fafc; }
        ::-webkit-scrollbar { width: 5px; height: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .panel { @apply bg-white border border-gray-200 rounded-lg shadow-sm flex flex-col overflow-hidden h-full transition-all duration-300; }
        .panel-header { @apply bg-gray-50/80 backdrop-blur border-b border-gray-100 px-3 py-2 font-bold text-gray-600 text-xs uppercase tracking-wide flex justify-between items-center z-10; }
        .panel-body { @apply flex-1 overflow-hidden p-3 relative; }
        .btn { @apply px-3 py-1.5 rounded text-xs font-semibold shadow-sm transition-all flex items-center gap-1.5 active:scale-95; }
        .btn-primary { @apply bg-blue-600 text-white hover:bg-blue-700; }
        .btn-success { @apply bg-emerald-600 text-white hover:bg-emerald-700; }
        .btn-outline { @apply bg-white text-gray-600 border border-gray-300 hover:bg-gray-50; }
        .btn-icon { @apply w-7 h-7 flex items-center justify-center rounded bg-white border border-gray-200 text-gray-500 hover:text-blue-600 hover:border-blue-400 shadow-sm transition-all active:scale-90; }
        .test-card { @apply bg-white border border-gray-100 rounded p-2 mb-2 hover:shadow-md hover:border-blue-300 transition-all border-l-[3px]; }
        .code-line { @apply text-[10px] font-mono text-gray-600 truncate block bg-gray-50 px-1 py-0.5 rounded mt-0.5; }
        .modal-overlay { @apply fixed inset-0 bg-gray-900/50 backdrop-blur-sm z-50 hidden flex items-center justify-center p-4; }
        .modal-content { @apply bg-white rounded-xl shadow-2xl w-full h-full max-w-[95vw] max-h-[90vh] flex flex-col overflow-hidden animate-zoom-in; }
        @keyframes zoomIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        .graph-wrapper { @apply w-full h-full cursor-grab active:cursor-grabbing overflow-hidden relative bg-slate-50/30; }
        .mermaid-container { @apply transform-gpu transition-transform duration-75 ease-out origin-center; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } } 
        .animate-fade-in-up { animation: fadeInUp 0.3s ease-out forwards; opacity: 0; }
        /* File Input Hide */
        input[type="file"] { display: none; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <!-- Header -->
    <header class="bg-white border-b border-gray-200 px-4 py-2 flex justify-between items-center shrink-0 z-20">
        <div class="flex items-center gap-3">
            <div class="w-8 h-8 bg-gradient-to-tr from-blue-600 to-cyan-500 rounded-lg text-white flex items-center justify-center shadow-lg shadow-blue-100">
                <i class="fa-solid fa-cube text-sm"></i>
            </div>
            <div>
                <h1 class="text-sm font-bold text-gray-800">Event-B TestGen</h1>
                <div class="flex items-center gap-2">
                    <span class="text-[10px] text-gray-500 font-medium">v13.0 Real XML Parser</span>
                    <span id="file-badge" class="hidden bg-indigo-100 text-indigo-800 text-[9px] px-1.5 rounded font-mono truncate max-w-[150px]"></span>
                </div>
            </div>
        </div>
        <div class="flex gap-2">
            <label class="btn btn-outline cursor-pointer">
                <i class="fa-solid fa-file-import"></i> Import .BUM/.XML
                <input type="file" id="fileInput" accept=".bum,.xml" onchange="handleFileUpload(this)">
            </label>
            <button onclick="generateAndOptimize()" class="btn btn-primary"><i class="fa-solid fa-play"></i> Analyze & Generate</button>
            <button onclick="exportDataZip()" class="btn btn-success"><i class="fa-solid fa-file-zipper"></i> Export</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 p-3 overflow-x-auto overflow-y-hidden bg-slate-50">
        <div class="min-w-[1280px] grid grid-cols-12 gap-3 h-full">
            
            <!-- Structure -->
            <div class="col-span-2 panel">
                <div class="panel-header">
                    <span><i class="fa-solid fa-sitemap mr-1.5 text-blue-500"></i> Structure</span>
                </div>
                <div class="panel-body space-y-3 overflow-y-auto" id="modelTree"></div>
            </div>

            <!-- Graph -->
            <div class="col-span-6 panel relative group">
                <div class="panel-header">
                    <span><i class="fa-solid fa-diagram-project mr-1.5 text-indigo-500"></i> Transition Graph</span>
                    <div class="flex items-center gap-3">
                        <div class="flex gap-2 text-[9px]">
                            <span class="flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>OK</span>
                            <span class="flex items-center gap-1"><span class="w-1.5 h-1.5 rounded-full bg-rose-500"></span>Revert</span>
                        </div>
                        <div class="h-4 w-px bg-gray-200"></div>
                        <div class="flex gap-1">
                            <button onclick="zoomGraph(0.1)" class="btn-icon"><i class="fa-solid fa-plus text-[10px]"></i></button>
                            <button onclick="zoomGraph(-0.1)" class="btn-icon"><i class="fa-solid fa-minus text-[10px]"></i></button>
                            <button onclick="resetZoom()" class="btn-icon"><i class="fa-solid fa-compress text-[10px]"></i></button>
                            <button onclick="toggleModal(true)" class="btn-icon ml-1 text-indigo-500"><i class="fa-solid fa-expand text-[10px]"></i></button>
                        </div>
                    </div>
                </div>
                <div class="panel-body p-0 relative bg-slate-50/50">
                    <div class="graph-wrapper" id="graphWrapper" onwheel="handleWheel(event)" onmousedown="startDrag(event)">
                        <div class="mermaid-container flex items-center justify-center w-full h-full" id="mermaidGraphContainer">
                            <div class="mermaid" id="mermaidGraph"></div>
                        </div>
                    </div>
                    <div id="graphPlaceholder" class="absolute inset-0 flex items-center justify-center pointer-events-none text-gray-400 text-xs animate-pulse">Waiting for file import...</div>
                </div>
            </div>

            <!-- Metrics -->
            <div class="col-span-2 panel">
                <div class="panel-header">
                    <span><i class="fa-solid fa-chart-pie mr-1.5 text-emerald-500"></i> Metrics</span>
                </div>
                <div class="panel-body flex flex-col gap-3 overflow-y-auto">
                    <div class="bg-emerald-50 border border-emerald-100 rounded-lg p-3 text-center">
                        <div class="text-[9px] text-gray-500 font-bold uppercase mb-0.5">Tests Generated</div>
                        <div class="text-3xl font-bold text-emerald-600 tracking-tighter" id="totalTestDisplay">0</div>
                    </div>
                    <div class="space-y-3 pt-1">
                        <div>
                            <div class="flex justify-between text-[10px] font-semibold text-gray-600 mb-1">
                                <span>Path Coverage</span> <span id="pathCovText" class="text-blue-600">0%</span>
                            </div>
                            <div class="w-full bg-gray-100 rounded-full h-1.5"><div id="pathCovBar" class="h-1.5 rounded-full bg-blue-500 w-0 transition-all duration-1000"></div></div>
                        </div>
                    </div>
                    <div class="flex-1 border-t border-gray-100 pt-2 mt-1">
                         <div class="text-[9px] font-bold text-gray-400 uppercase mb-2">Guard Analysis</div>
                         <div id="guardBreakdown" class="space-y-1"></div>
                    </div>
                </div>
            </div>

            <!-- Test Cases -->
            <div class="col-span-2 panel border-t-[3px] border-t-blue-500">
                <div class="panel-header bg-white">
                    <span class="text-blue-700"><i class="fa-solid fa-list-check mr-1.5"></i> Test Cases</span>
                </div>
                <div class="panel-body bg-slate-50 p-2 overflow-y-auto" id="testCaseList">
                     <div class="flex flex-col items-center justify-center h-full text-gray-300 text-xs text-center opacity-60">
                        <i class="fa-solid fa-file-code text-2xl mb-2"></i>
                        Please import .bum file
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal -->
    <div id="graphModal" class="modal-overlay">
        <div class="modal-content relative">
            <div class="absolute top-4 right-4 z-50 flex gap-2">
                <button onclick="toggleModal(false)" class="w-10 h-10 rounded-full bg-white text-gray-500 hover:text-red-500 shadow-md flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="w-full h-full bg-slate-50 cursor-grab flex items-center justify-center" id="modalWrapper" onwheel="handleModalWheel(event)" onmousedown="startModalDrag(event)">
                <div id="modalGraphContainer" class="transform-gpu transition-transform duration-75"><div class="mermaid" id="modalMermaid"></div></div>
            </div>
        </div>
    </div>

    <script>
        // --- 1. CORE DATA MODELS ---
        let currentModel = {
            name: "Default",
            variables: [],
            invariants: [],
            events: []
        };
        let generatedSuite = [];
        let currentGraphDef = "";

        // --- 2. FILE PARSING LOGIC (THE "READER") ---
        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                const content = e.target.result;
                
                // Show badge
                const badge = document.getElementById('file-badge');
                badge.textContent = file.name;
                badge.classList.remove('hidden');

                try {
                    parseEventB(content);
                } catch (err) {
                    alert("Error parsing file: " + err.message);
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

        function parseEventB(xmlString) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlString, "text/xml");

            // Reset Model
            currentModel = { name: "Imported_Machine", variables: [], invariants: [], events: [] };

            // 1. Parse Variables
            const vars = xmlDoc.getElementsByTagName("org.eventb.core.variable");
            for (let i = 0; i < vars.length; i++) {
                currentModel.variables.push(vars[i].getAttribute("org.eventb.core.identifier"));
            }

            // 2. Parse Invariants
            const invs = xmlDoc.getElementsByTagName("org.eventb.core.invariant");
            for (let i = 0; i < invs.length; i++) {
                currentModel.invariants.push(
                    invs[i].getAttribute("org.eventb.core.label") + ": " + 
                    invs[i].getAttribute("org.eventb.core.predicate")
                );
            }

            // 3. Parse Events
            const events = xmlDoc.getElementsByTagName("org.eventb.core.event");
            for (let i = 0; i < events.length; i++) {
                const evtName = events[i].getAttribute("org.eventb.core.label");
                
                // Get Guards
                const guards = [];
                const guardNodes = events[i].getElementsByTagName("org.eventb.core.guard");
                for (let j = 0; j < guardNodes.length; j++) {
                    guards.push(guardNodes[j].getAttribute("org.eventb.core.predicate"));
                }

                currentModel.events.push({
                    name: evtName,
                    type: evtName === "INITIALISATION" ? "init" : "normal",
                    guards: guards
                });
            }
            
            // If no valid BUM/XML structure found, fallback to Demo Model
            if (currentModel.events.length === 0) {
                // Fallback for demonstration if user uploads random file
                alert("No valid Event-B structure found. Using demo Wallet model.");
                useDemoModel();
            }

            renderStructure();
            generateGraphFromModel();
        }

        function useDemoModel() {
            currentModel = {
                name: "Wallet_RefM2",
                variables: ["balance", "currUser", "state"],
                invariants: ["balance >= 0"],
                events: [
                    { name: "INITIALISATION", type: "init", guards: [] },
                    { name: "Deposit", type: "normal", guards: ["state=active"] },
                    { name: "Withdraw", type: "normal", guards: ["state=active", "bal>=amt"] },
                    { name: "Transfer", type: "normal", guards: ["state=active", "bal>=amt"] },
                    { name: "Emergency", type: "normal", guards: ["user=owner"] }
                ]
            };
        }

        // --- 3. GENERATION LOGIC ---
        function generateAndOptimize() {
            if (currentModel.events.length === 0) {
                alert("Please import a model first!");
                return;
            }

            const list = document.getElementById('testCaseList');
            list.innerHTML = '';
            generatedSuite = [];
            let id = 1;

            currentModel.events.forEach(evt => {
                // Positive Case (Satisfy Guards)
                const guardsText = evt.guards.length > 0 ? evt.guards.join(" AND ") : "True";
                
                generatedSuite.push({
                    id: `TC${id++}`,
                    event: evt.name,
                    type: "T",
                    desc: `Verify ${evt.name} success`,
                    in: `Guards: [${guardsText}] == True`,
                    out: "State Update OK"
                });

                // Negative Case (Violate Guards - Simple Negation)
                if (evt.type !== "init" && evt.guards.length > 0) {
                    generatedSuite.push({
                        id: `TC${id++}`,
                        event: evt.name,
                        type: "F",
                        desc: `Verify ${evt.name} fail`,
                        in: `Guards: [${guardsText}] == False`,
                        out: "REVERT"
                    });
                }
            });

            updateUI();
        }

        function updateUI() {
            // Update List
            const list = document.getElementById('testCaseList');
            list.innerHTML = '';
            generatedSuite.forEach((tc, i) => {
                const color = tc.type === 'T' ? 'border-l-emerald-500' : 'border-l-rose-500';
                list.innerHTML += `
                    <div class="test-card ${color} animate-fade-in-up" style="animation-delay: ${i*50}ms">
                        <div class="flex justify-between items-center mb-1">
                            <span class="font-bold text-[11px] text-gray-700">${tc.id}</span>
                            <span class="text-[9px] font-mono text-gray-400 bg-gray-100 px-1 rounded">${tc.event}</span>
                        </div>
                        <div class="text-[10px] text-gray-600 mb-1 truncate">${tc.desc}</div>
                        <div class="bg-gray-50 border border-gray-100 rounded p-1">
                            <span class="code-line"><span class="font-bold text-gray-400">INPUT :</span> ${tc.in}</span>
                            <span class="code-line ${tc.type === 'T'?'text-emerald-600':'text-rose-500'}"><span class="font-bold text-gray-400">EXPECT:</span> ${tc.out}</span>
                        </div>
                    </div>`;
            });

            // Update Metrics
            document.getElementById('totalTestDisplay').innerText = generatedSuite.length;
            document.getElementById('pathCovBar').style.width = '100%';
            document.getElementById('pathCovText').innerText = '100%';
            
            renderGuardBreakdown();
        }

        // --- 4. RENDERING HELPERS ---
        function renderStructure() {
            const tree = document.getElementById('modelTree');
            tree.innerHTML = ''; 
            const addGroup = (title, items, icon) => {
                if(items.length === 0) return;
                const div = document.createElement('div');
                div.innerHTML = `<div class="font-bold text-[10px] text-gray-400 uppercase mb-1 mt-2 first:mt-0"><i class="fa-solid ${icon} mr-1"></i>${title}</div>`;
                items.forEach(i => div.innerHTML += `<div class="text-[10px] text-gray-700 ml-1 pl-2 border-l border-gray-200 py-0.5 truncate" title="${i}">${i}</div>`);
                tree.appendChild(div);
            };
            addGroup("Variables", currentModel.variables, "fa-cube");
            addGroup("Invariants", currentModel.invariants, "fa-scale-balanced");
            addGroup("Events", currentModel.events.map(e => e.name), "fa-bolt");
        }

        function generateGraphFromModel() {
            let g = "graph TD\nStart((Start)):::start --> Init[Init]:::success\n";
            let hasInit = false;

            currentModel.events.forEach(evt => {
                if (evt.type === 'init') { hasInit = true; return; }
                const safeName = evt.name.replace(/\W/g, '');
                g += `Init -->|${evt.name}| ${safeName}[${evt.name}]\n`;
            });

            if (!hasInit) g = "graph TD\nStart((Start)):::start --> Machine[Machine State]\n";
            
            g += "classDef success fill:#d1fae5,stroke:#10b981,stroke-width:1.5px;\n";
            g += "classDef start fill:#f1f5f9,stroke:#94a3b8,stroke-width:2px;\n";

            currentGraphDef = g;
            renderGraph(g);
        }

        function renderGraph(def) {
            const el = document.getElementById('mermaidGraph');
            document.getElementById('graphPlaceholder').style.display = 'none';
            el.innerHTML = def;
            el.removeAttribute('data-processed');
            mermaid.init(undefined, el);
        }

        function renderGuardBreakdown() {
            const container = document.getElementById('guardBreakdown');
            container.innerHTML = '';
            currentModel.events.forEach(evt => {
                if(evt.type === 'init') return;
                const gCount = evt.guards.length;
                container.innerHTML += `
                    <div class="flex justify-between items-center text-[10px] py-1 border-b border-gray-50 last:border-0 hover:bg-gray-50 px-1 rounded">
                        <span class="font-medium text-gray-600 truncate w-20" title="${evt.name}">${evt.name}</span>
                        <span class="text-xs text-gray-400">${gCount} guards</span>
                    </div>`;
            });
        }

        // --- 5. EXPORT ---
        function exportDataZip() {
            if (generatedSuite.length === 0) return alert("Generate tests first!");
            const zip = new JSZip();
            zip.file("test_suite.json", JSON.stringify(generatedSuite, null, 2));
            zip.generateAsync({type:"blob"}).then(c => {
                const a = document.createElement('a'); a.href = URL.createObjectURL(c); a.download = "EventB_Tests.zip"; a.click();
            });
        }

        // Zoom/Pan/Modal Boilerplate (Same as before)
        let scale = 1, panning = false, pointX = 0, pointY = 0, startX = 0, startY = 0;
        let mScale = 1.5, mPanning = false, mPointX = 0, mPointY = 0, mStartX = 0, mStartY = 0;
        function setTransform() { document.getElementById('mermaidGraphContainer').style.transform = `translate(${pointX}px, ${pointY}px) scale(${scale})`; }
        function zoomGraph(delta) { scale += delta; if (scale < 0.2) scale = 0.2; if (scale > 5) scale = 5; setTransform(); }
        function resetZoom() { scale = 1; pointX = 0; pointY = 0; setTransform(); }
        function handleWheel(e) { e.preventDefault(); zoomGraph(e.deltaY > 0 ? -0.1 : 0.1); }
        function startDrag(e) { panning = true; startX = e.clientX - pointX; startY = e.clientY - pointY; document.getElementById('graphWrapper').style.cursor = 'grabbing'; document.addEventListener('mousemove', onDrag); document.addEventListener('mouseup', endDrag); }
        function onDrag(e) { if (!panning) return; e.preventDefault(); pointX = e.clientX - startX; pointY = e.clientY - startY; setTransform(); }
        function endDrag() { panning = false; document.getElementById('graphWrapper').style.cursor = 'grab'; document.removeEventListener('mousemove', onDrag); document.removeEventListener('mouseup', endDrag); }
        function toggleModal(show) {
            const modal = document.getElementById('graphModal');
            if (show) {
                modal.classList.remove('hidden');
                document.getElementById('modalMermaid').innerHTML = currentGraphDef;
                mermaid.init(undefined, document.getElementById('modalMermaid'));
            } else modal.classList.add('hidden');
        }
        function handleModalWheel(e) { e.preventDefault(); mScale += e.deltaY > 0 ? -0.1 : 0.1; if(mScale<0.2) mScale=0.2; document.getElementById('modalGraphContainer').style.transform = `translate(${mPointX}px, ${mPointY}px) scale(${mScale})`; }
        function startModalDrag(e) { mPanning = true; mStartX = e.clientX - mPointX; mStartY = e.clientY - mPointY; document.getElementById('modalWrapper').style.cursor = 'grabbing'; document.addEventListener('mousemove', onModalDrag); document.addEventListener('mouseup', endModalDrag); }
        function onModalDrag(e) { if(!mPanning)return; e.preventDefault(); mPointX=e.clientX-mStartX; mPointY=e.clientY-mStartY; document.getElementById('modalGraphContainer').style.transform = `translate(${mPointX}px, ${mPointY}px) scale(${mScale})`; }
        function endModalDrag() { mPanning=false; document.getElementById('modalWrapper').style.cursor = 'grab'; document.removeEventListener('mousemove', onModalDrag); document.removeEventListener('mouseup', endModalDrag); }

        mermaid.initialize({ startOnLoad: false, theme: 'default' });
    </script>
</body>
</html>